name: Push Notify

on:
  schedule:
    # Every 30 minutes — covers 8 AM–10 PM ET year-round (EST=UTC-5, EDT=UTC-4)
    # Two entries because POSIX cron can't wrap midnight in a single range.
    # The script itself enforces the 8 AM–10 PM ET gate.
    - cron: '*/30 12-23 * * *'
    - cron: '*/30 0-3 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

concurrency:
  group: push-notify
  cancel-in-progress: false

jobs:
  notify:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup-node-deps

      - name: Run check-and-notify
        env:
          CLOUDFLARE_WORKER_URL: ${{ secrets.CLOUDFLARE_WORKER_URL }}
          NOTIFY_API_KEY: ${{ secrets.NOTIFY_API_KEY }}
        run: node scripts/check-and-notify.mjs

      - name: Open issue on failure
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          DATE=$(date -u +%Y-%m-%d)
          gh issue create \
            --title "Push notify cron failed — ${DATE}" \
            --body "The push-notify cron job failed. See the run for details: ${RUN_URL}" \
            --label "bug"
