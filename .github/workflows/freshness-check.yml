name: Data Freshness Check

on:
  schedule:
    # 9 AM UTC daily - 4 hours after the scraper (5 AM UTC), buffer for cron delays
    - cron: '0 9 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

concurrency:
  group: freshness-check
  cancel-in-progress: false

jobs:
  check-freshness:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check data freshness
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # Guard: file must exist
          if [ ! -f public/data/latest.json ]; then
            echo "ERROR: public/data/latest.json not found in checkout"
            exit 1
          fi

          # Extract scrapedAt
          SCRAPED_AT=$(jq -r '.scrapedAt' public/data/latest.json)
          if [ -z "$SCRAPED_AT" ] || [ "$SCRAPED_AT" = "null" ]; then
            echo "ERROR: scrapedAt is missing or null in public/data/latest.json"
            exit 1
          fi

          # Compute age in whole hours
          NOW_EPOCH=$(date -u +%s)
          SCRAPED_EPOCH=$(date -u -d "$SCRAPED_AT" +%s)
          AGE_HOURS=$(( (NOW_EPOCH - SCRAPED_EPOCH) / 3600 ))

          echo "scrapedAt:  $SCRAPED_AT"
          echo "Now (UTC):  $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Age:        ${AGE_HOURS}h"
          echo "Threshold:  26h"

          # Ensure the stale-data label exists (idempotent)
          gh label create stale-data --description "Automated: schedule data not refreshed in 26+ hours" --color e4e669 2>/dev/null || true

          if [ "$AGE_HOURS" -gt 26 ]; then
            echo "STALE: data is ${AGE_HOURS}h old - exceeds 26h threshold"

            existing=$(gh issue list --label "stale-data" --state open --limit 1 --json number --jq '.[0].number')

            if [ -n "$existing" ]; then
              gh issue comment "$existing" --body "Schedule data still stale as of **$(date -u +%Y-%m-%d)** (${AGE_HOURS}h old).

          - **scrapedAt**: \`$SCRAPED_AT\`
          - **[Freshness check run](https://github.com/$REPO/actions/runs/$RUN_ID)**"
              echo "Commented on existing issue #$existing"
            else
              gh issue create \
                --title "Schedule data is stale (${AGE_HOURS}h since last update)" \
                --label "stale-data" \
                --body "The schedule data in \`public/data/latest.json\` has not been refreshed in **${AGE_HOURS} hours** (last updated: \`$SCRAPED_AT\`).

          The daily scraper runs at **5:00 AM UTC**. Data this old suggests the scraper workflow was skipped, disabled, or the git push step failed silently.

          ### Debugging checklist
          1. Check recent **[Scrape & Deploy runs](https://github.com/$REPO/actions/workflows/scrape-and-deploy.yml)** -- did the workflow run at all? GitHub skips cron jobs on repos with no recent activity.
          2. Check **[latest.json in the repo](https://github.com/$REPO/blob/main/public/data/latest.json)** -- is \`scrapedAt\` outdated there too?
          3. Check whether the Scrape & Deploy workflow is enabled under **Actions -> Workflows**.
          4. If the scraper step itself crashed, there may also be an open \`scraper-failure\` issue.

          ### User impact
          The in-app stale banner appears after **48 hours**. Until then, users see stale data with no warning.

          **[View this freshness check run](https://github.com/$REPO/actions/runs/$RUN_ID)**

          Close this issue once \`scrapedAt\` is within 26 hours."
              echo "Created new stale-data issue"
            fi

          else
            echo "FRESH: data is ${AGE_HOURS}h old - within 26h threshold"

            # Auto-close all open stale-data issues (loop handles edge case of >1 open)
            while IFS= read -r issue_number; do
              [ -z "$issue_number" ] && continue
              gh issue comment "$issue_number" --body "Schedule data is fresh again as of **$(date -u +%Y-%m-%d)** (${AGE_HOURS}h old - within 26h threshold).

          - **scrapedAt**: \`$SCRAPED_AT\`
          - **[Freshness check run](https://github.com/$REPO/actions/runs/$RUN_ID)**

          Closing automatically."
              gh issue close "$issue_number"
              echo "Closed stale-data issue #$issue_number"
            done < <(gh issue list --label "stale-data" --state open --limit 5 --json number --jq '.[].number')
          fi
