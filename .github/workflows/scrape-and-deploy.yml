name: Scrape & Deploy

on:
  schedule:
    # Midnight Eastern Time (5:00 AM UTC during EST, 4:00 AM during EDT)
    - cron: '0 5 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  issues: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  scrape-build-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Cache node_modules
        id: node-modules-cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.node-modules-cache.outputs.cache-hit != 'true'
        run: npm ci

      # Keep in sync with ci.yml playwright cache
      - name: Get Playwright version
        run: echo "PLAYWRIGHT_VERSION=$(node -e "console.log(require('./package-lock.json').packages['node_modules/playwright'].version)")" >> $GITHUB_ENV

      - name: Cache Playwright Chromium
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-chromium-${{ runner.os }}-${{ env.PLAYWRIGHT_VERSION }}

      - name: Install Playwright Chromium
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright OS dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Run scraper
        id: scrape
        run: npx tsx scraper/index.ts

      - name: Open issue on scraper failure
        if: failure() && steps.scrape.outcome == 'failure'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # Ensure label exists (idempotent)
          gh label create scraper-failure --description "Automated: scraper validation failed" --color d73a4a 2>/dev/null || true
          # Check for existing open issue to avoid duplicates
          existing=$(gh issue list --label "scraper-failure" --state open --limit 1 --json number --jq '.[0].number')
          if [ -n "$existing" ]; then
            gh issue comment "$existing" --body "Scraper still failing as of $(date -u +%Y-%m-%d). [Workflow run](https://github.com/$REPO/actions/runs/$RUN_ID)"
            echo "Commented on existing issue #$existing"
          else
            gh issue create \
              --title "Scraper validation failed" \
              --label "scraper-failure" \
              --body "The daily scraper failed on **$(date -u +%Y-%m-%d)**.

          This likely means the Fair Lawn website changed its HTML structure or was temporarily unavailable.

          **[View workflow logs](https://github.com/$REPO/actions/runs/$RUN_ID)**

          ### Next steps
          1. Check workflow logs for specific validation errors
          2. Visit [fairlawn.org/community-center](https://www.fairlawn.org/community-center) to check for structural changes
          3. Update \`scraper/parse.ts\` if needed
          4. Close this issue when resolved"
          fi

      - name: Commit updated schedule data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/data/
          git diff --staged --quiet || git commit -m "Update schedule $(date -u +%Y-%m-%d)"
          git push

      - name: Build site
        run: npm run build

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
